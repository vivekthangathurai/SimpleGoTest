apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: ci-k8s-webhook-handler-
spec:
  entrypoint: ci
  serviceAccountName: k8s-webhook-handler
  arguments:
    parameters:
      - name: image
        value: "vivek125/k8s-webhook-handler:{{workflow.annotations.k8s-webhook-handler.io/revision}}"
  volumes:
    - name: docker-config
      configMap:
        name: docker-config     
  templates:
    - name: ci
      dag:
        tasks:
          - name: build
            template: build
          - name: deploy
            template: deploy
            dependencies: [build]  
    - name: build
      metadata:
        annotations:
          iam.amazonaws.com/role: ci-role
      inputs:
        artifacts:
          - name: source
            path: /src
            git:
              repo: "https://github.com/vivekthangathurai/SimpleGoTest.git"
              revision: "{{workflow.annotations.k8s-webhook-handler.io/revision}}"
      container:
        image: gcr.io/kaniko-project/executor
        args:
          - "--context=/src"
          - "--destination={{workflow.parameters.image}}"
        volumeMounts:
          - name: docker-config
            mountPath: /kaniko/.docker/   
    - name: deploy
      inputs:
        artifacts:
          - name: source
            path: /src
            git:
              repo: "https://github.com/vivekthangathurai/SimpleGoTest.git"
              revision: "{{workflow.annotations.k8s-webhook-handler.io/revision}}" 
      container:
        image: bitnami/kubectl:latest
        args: ["apply", "-f", "src/configmap.yaml","-n","argo"]        
